{% extends "base.html" %}

{% block title %}Reset Password - Speed Dating{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <!-- Logo and Header -->
        <div class="text-center">
            <div class="flex justify-center mb-4">
                <div class="p-4 bg-red-900/50 rounded-full">
                    <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m0 0a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9a2 2 0 012-2m0 0V7a2 2 0 012-2m3 0a2 2 0 00-2-2m0 0a2 2 0 00-2 2"></path>
                    </svg>
                </div>
            </div>
            <h1 class="text-4xl font-bold text-gradient mb-2">Reset Password</h1>
            <h2 class="text-xl text-slate-300">Set your new password</h2>
            <p class="text-sm text-slate-400 mt-2" id="user-info">
                Loading...
            </p>
        </div>

        <!-- Token Validation Loading -->
        <div id="loading-container" class="card">
            <div class="text-center py-8">
                <svg class="animate-spin w-8 h-8 text-red-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <p class="text-slate-300">Validating reset token...</p>
            </div>
        </div>

        <!-- Reset Password Form (hidden initially) -->
        <div id="form-container" class="card hidden">
            <form id="reset-password-form" 
                  hx-post="/auth/reset-password/{{ token }}" 
                  hx-target="#result-container"
                  hx-swap="innerHTML"
                  class="space-y-6">
                
                <!-- CSRF Protection -->
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <!-- Password -->
                <div class="form-group">
                    <label for="password" class="form-label required">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
                        </svg>
                        New Password
                    </label>
                    <input 
                        id="password"
                        name="password" 
                        type="password" 
                        required 
                        minlength="8"
                        maxlength="128"
                        class="form-input"
                        placeholder="Enter your new password"
                        autocomplete="new-password"
                    >
                    <p class="form-help">
                        Must be at least 8 characters long.
                    </p>
                </div>

                <!-- Confirm Password -->
                <div class="form-group">
                    <label for="confirm_password" class="form-label required">
                        <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Confirm New Password
                    </label>
                    <input 
                        id="confirm_password"
                        name="confirm_password" 
                        type="password" 
                        required 
                        minlength="8"
                        maxlength="128"
                        class="form-input"
                        placeholder="Confirm your new password"
                        autocomplete="new-password"
                    >
                    <p class="form-help">
                        Must match the password above.
                    </p>
                </div>

                <!-- Password Strength Indicator -->
                <div class="form-group">
                    <div class="password-strength hidden">
                        <div class="flex items-center justify-between text-xs mb-2">
                            <span class="text-slate-400">Password Strength</span>
                            <span id="strength-text" class="text-slate-400">-</span>
                        </div>
                        <div class="w-full bg-slate-700 rounded-full h-2">
                            <div id="strength-bar" class="h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="form-group">
                    <button 
                        type="submit" 
                        class="btn btn-primary w-full">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Reset Password
                    </button>
                </div>
            </form>

            <!-- Result Container -->
            <div id="result-container" class="mt-6"></div>
        </div>

        <!-- Error Container (for token validation errors) -->
        <div id="error-container" class="card hidden">
            <div class="bg-red-900/20 border border-red-600/30 rounded-lg p-4">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-red-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h3 class="text-sm font-medium text-red-300">Invalid Reset Link</h3>
                        <p class="text-xs text-red-200 mt-1" id="error-message">
                            This password reset link is invalid or has expired.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 text-center">
                <a href="/auth/forgot-password" 
                   class="text-red-400 hover:text-red-300 font-medium">
                    Request a new reset link
                </a>
            </div>
        </div>

        <!-- Back to Login -->
        <div class="text-center">
            <p class="text-sm text-slate-400">
                Remember your password?
                <a href="/auth/login" 
                   class="text-red-400 hover:text-red-300 font-medium">
                    Sign in here
                </a>
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const token = '{{ token }}';
    const loadingContainer = document.getElementById('loading-container');
    const formContainer = document.getElementById('form-container');
    const errorContainer = document.getElementById('error-container');
    const userInfo = document.getElementById('user-info');
    const form = document.getElementById('reset-password-form');
    const resultContainer = document.getElementById('result-container');
    
    // Validate token on page load
    fetch(`/auth/reset-password/${token}/validate`)
        .then(response => response.json())
        .then(data => {
            loadingContainer.classList.add('hidden');
            
            if (data.valid) {
                // Token is valid, show form
                userInfo.textContent = `Create a new password for ${data.user_email}`;
                formContainer.classList.remove('hidden');
                document.getElementById('password').focus();
            } else {
                // Token is invalid, show error
                document.getElementById('error-message').textContent = data.message || 'This password reset link is invalid or has expired.';
                errorContainer.classList.remove('hidden');
            }
        })
        .catch(error => {
            console.error('Error validating token:', error);
            loadingContainer.classList.add('hidden');
            document.getElementById('error-message').textContent = 'Failed to validate reset link. Please try again.';
            errorContainer.classList.remove('hidden');
        });
    
    // Password strength checker
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const strengthContainer = document.querySelector('.password-strength');
    const strengthBar = document.getElementById('strength-bar');
    const strengthText = document.getElementById('strength-text');
    
    function checkPasswordStrength(password) {
        let score = 0;
        let feedback = [];
        
        if (password.length >= 8) score += 1;
        else feedback.push('at least 8 characters');
        
        if (password.match(/[a-z]/)) score += 1;
        else feedback.push('lowercase letters');
        
        if (password.match(/[A-Z]/)) score += 1;
        else feedback.push('uppercase letters');
        
        if (password.match(/[0-9]/)) score += 1;
        else feedback.push('numbers');
        
        if (password.match(/[^A-Za-z0-9]/)) score += 1;
        else feedback.push('special characters');
        
        const strength = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'][score];
        const colors = ['bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-blue-500', 'bg-green-500'];
        const widths = [20, 40, 60, 80, 100];
        
        return {
            score,
            strength,
            color: colors[score],
            width: widths[score],
            feedback
        };
    }
    
    passwordInput.addEventListener('input', function() {
        const password = this.value;
        
        if (password.length > 0) {
            strengthContainer.classList.remove('hidden');
            const result = checkPasswordStrength(password);
            
            strengthBar.className = `h-2 rounded-full transition-all duration-300 ${result.color}`;
            strengthBar.style.width = `${result.width}%`;
            strengthText.textContent = result.strength;
        } else {
            strengthContainer.classList.add('hidden');
        }
    });
    
    // Password confirmation validation
    function validatePasswordMatch() {
        const password = passwordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        if (confirmPassword.length > 0) {
            if (password === confirmPassword) {
                confirmPasswordInput.classList.remove('border-red-500');
                confirmPasswordInput.classList.add('border-green-500');
            } else {
                confirmPasswordInput.classList.remove('border-green-500');
                confirmPasswordInput.classList.add('border-red-500');
            }
        } else {
            confirmPasswordInput.classList.remove('border-red-500', 'border-green-500');
        }
    }
    
    passwordInput.addEventListener('input', validatePasswordMatch);
    confirmPasswordInput.addEventListener('input', validatePasswordMatch);
    
    // Handle form submission response
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.target.id === 'reset-password-form') {
            const response = event.detail.xhr.response;
            
            try {
                const data = JSON.parse(response);
                
                if (event.detail.successful && data.success) {
                    // Success
                    resultContainer.innerHTML = `
                        <div class="bg-green-900/20 border border-green-600/30 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-green-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <h3 class="text-sm font-medium text-green-300">${data.message}</h3>
                                    <p class="text-xs text-green-200 mt-1">
                                        Redirecting to login page...
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Disable the form
                    form.style.display = 'none';
                    
                    // Redirect after a delay
                    setTimeout(() => {
                        window.location.href = '/auth/login';
                    }, 3000);
                    
                } else {
                    // Error from API
                    const message = data.message || data.detail || 'An error occurred';
                    resultContainer.innerHTML = `
                        <div class="bg-red-900/20 border border-red-600/30 rounded-lg p-4">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-red-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                <div>
                                    <h3 class="text-sm font-medium text-red-300">Reset Failed</h3>
                                    <p class="text-xs text-red-200 mt-1">${message}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (e) {
                // Parse error or other issue
                resultContainer.innerHTML = `
                    <div class="bg-red-900/20 border border-red-600/30 rounded-lg p-4">
                        <div class="flex items-center">
                            <svg class="w-5 h-5 text-red-400 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <h3 class="text-sm font-medium text-red-300">Reset Failed</h3>
                                <p class="text-xs text-red-200 mt-1">An unexpected error occurred. Please try again.</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
    });
    
    // Handle loading state
    document.body.addEventListener('htmx:beforeRequest', function(event) {
        if (event.target.id === 'reset-password-form') {
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <svg class="animate-spin w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Resetting Password...
            `;
        }
    });
    
    document.body.addEventListener('htmx:afterRequest', function(event) {
        if (event.target.id === 'reset-password-form') {
            const submitBtn = form.querySelector('button[type="submit"]');
            if (!submitBtn.disabled) {
                submitBtn.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    Reset Password
                `;
            }
        }
    });
});
</script>
{% endblock %}